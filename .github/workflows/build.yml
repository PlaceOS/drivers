name: Build and Publish Drivers
on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

env:
  CRYSTAL_VERSION: 1.4.1

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    environment: Build
    steps:
      - uses: actions/checkout@v3

      # Cache Logic (monthly)
      #############################################################################################

      - name: Date
        id: get-date
        run: |
          echo "::set-output name=date::$(/bin/date -u "+%Y%m")"
      - uses: actions/cache@v3
        with:
          path: binaries
          key: ${{ env.CRYSTAL_VERSION }}-${{ steps.get-date.outputs.date }}

      #############################################################################################

      - uses: FranzDiebold/github-env-vars-action@v2  # https://github.com/github/feedback/discussions/5251
      - name: Build Drivers
        run: |
          ./harness build \
            --discover \
            --strict-driver-info \
            --repository-uri https://github.com/${{ github.repository }} \
            --repository-path ./repositories/local \
            --ref ${{ github.sha }}
        env:
          CRYSTAL_VERSION: ${{ env.CRYSTAL_VERSION }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_SECRET: ${{ secrets.AWS_SECRET }}
          AWS_KEY: ${{ secrets.AWS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
